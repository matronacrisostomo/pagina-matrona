<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Matrona Cris√≥stomo ‚Äî Servicios y Agenda</title>
<meta name="description" content="Matrona Daniela Cris√≥stomo ‚Äî Salud √≠ntima, PRP, HIFU, Plasmapen, toma de ex√°menes y m√°s. Reserva en Linares o Talca." />
<style>
  :root{
    --bg-a:#fff6f9;
    --bg-b:#fff1f6;
    --accent:#e84a94;
    --accent-2:#ff7bb0;
    --muted:#6b6b6b;
    --card:#ffffff;
    --glass: rgba(255,255,255,0.7);
    --success:#28a745;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;
    background: linear-gradient(180deg,var(--bg-a),var(--bg-b));
    color:#222;-webkit-font-smoothing:antialiased;
  }

  /* Header */
  header{
    display:flex;align-items:center;justify-content:space-between;padding:14px 20px;
    background: linear-gradient(90deg,var(--accent),var(--accent-2)); color:#fff;
    position:sticky;top:0;z-index:60;box-shadow:0 6px 18px rgba(0,0,0,0.08);
  }
  .brand{display:flex;gap:12px;align-items:center}
  .logo{
    width:48px;height:48px;border-radius:12px;background:linear-gradient(135deg,#fff,#ffd7ec);
    display:flex;align-items:center;justify-content:center;color:var(--accent);font-weight:800;
    box-shadow:0 6px 18px rgba(255,77,166,0.12);
  }
  header h1{margin:0;font-size:1.05rem}
  nav{display:flex;gap:12px}
  nav a{color:rgba(255,255,255,0.95);text-decoration:none;font-weight:600;padding:8px;border-radius:8px}
  nav a:hover{background:rgba(255,255,255,0.08)}

  /* Layout */
  .container{max-width:1150px;margin:28px auto;padding:0 18px}
  .hero{
    display:grid;grid-template-columns:1fr 420px;gap:20px;padding:26px;border-radius:16px;
    background: linear-gradient(180deg,rgba(255,255,255,0.94), rgba(255,255,255,0.88));
    box-shadow:0 14px 40px rgba(255,77,166,0.06);backdrop-filter: blur(6px);
  }
  .hero h2{margin:0 0 8px;color:var(--accent);font-size:1.6rem}
  .hero p{margin:0;color:var(--muted)}
  .cta{margin-top:14px}
  .btn{
    display:inline-block;background:var(--accent);color:#fff;padding:10px 16px;border-radius:999px;border:0;
    cursor:pointer;font-weight:700;text-decoration:none;box-shadow:0 8px 20px rgba(255,77,166,0.08);
    transition:transform .12s ease, box-shadow .12s ease;
  }
  .btn.secondary{background:#fff;color:var(--accent);border:1px solid rgba(255,77,166,0.08)}
  .btn:hover{transform:translateY(-3px)}

  .hero-right{background:linear-gradient(180deg,#fff,#fff9fb);padding:10px;border-radius:12px}
  .hero-right img{width:100%;height:260px;object-fit:cover;border-radius:10px}

  .section{margin-top:22px}
  .card{background:var(--card);border-radius:12px;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,0.04)}
  .services-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:14px;margin-top:12px}
  .service{
    border-radius:12px;padding:12px;background:linear-gradient(180deg,#fff,#fffaf6);border:1px solid rgba(0,0,0,0.03);
    transition:transform .14s ease, box-shadow .14s ease;display:flex;flex-direction:column;
  }
  .service:hover{transform:translateY(-6px);box-shadow:0 20px 40px rgba(255,77,166,0.05)}
  .service img{width:100%;height:120px;object-fit:cover;border-radius:8px;margin-bottom:8px}
  .service h4{margin:0 0 6px;color:#b4006a}
  .service p{margin:0;color:var(--muted);font-size:0.95rem}
  .price{margin-top:auto;margin-top:10px;font-weight:800;color:var(--accent)}

  .grid{display:grid;grid-template-columns:1fr 420px;gap:20px;margin-top:18px;align-items:start}

  /* Calendar inputs */
  .calendar{display:flex;flex-direction:column;gap:10px}
  label{display:block;font-size:0.9rem;color:var(--muted);margin-bottom:6px}
  input[type="date"],select,input[type="text"],input[type="email"],input[type="tel"],textarea{
    width:100%;padding:10px;border-radius:10px;border:1px solid #eee;background:#fff;font-size:0.95rem
  }
  .hours{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
  .hour{
    padding:8px 12px;border-radius:12px;background:linear-gradient(180deg,#fff,#ffe9f6);
    border:1px solid rgba(255,77,166,0.15);cursor:pointer;font-weight:700;
  }
  .hour.disabled{background:#f2f2f2;color:#aaa;border-color:#eee;cursor:not-allowed;text-decoration:line-through}
  .hour.selected{outline:3px solid rgba(255,77,166,0.12)}
  .small{font-size:0.85rem;color:var(--muted)}

  .admin-panel{margin-top:12px;padding:12px;border-radius:10px;background:linear-gradient(180deg,#fff7fb,#fff0f6);border:1px solid rgba(255,77,166,0.08)}
  .chip{display:inline-flex;align-items:center;padding:6px 10px;border-radius:999px;background:#fff;border:1px solid #ffd7ec;font-weight:700}
  .reserved-list{margin-top:10px}
  .reserved-item{display:flex;justify-content:space-between;padding:8px;border-radius:8px;background:#fff8fb;border:1px solid rgba(0,0,0,0.03);margin-bottom:8px}

  footer{margin-top:28px;padding:18px;text-align:center;color:var(--muted)}
  .socials{display:flex;gap:10px;justify-content:center;margin-top:8px}

  .whatsapp-fab{position:fixed;right:18px;bottom:18px;background:#25d366;color:#fff;border-radius:999px;width:58px;height:58px;display:flex;align-items:center;justify-content:center;font-size:22px;box-shadow:0 14px 36px rgba(0,0,0,0.16);z-index:90;text-decoration:none}

  .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.35);display:flex;align-items:center;justify-content:center;z-index:120}
  .modal{width:520px;background:#fff;border-radius:12px;padding:20px;box-shadow:0 22px 56px rgba(0,0,0,0.25)}
  .modal h4{margin:0 0 8px;color:var(--accent)}

  @media (max-width:1000px){
    .hero{grid-template-columns:1fr;align-items:stretch}
    .grid{grid-template-columns:1fr}
    .hero-right{display:none}
    .modal{width:92%}
  }
</style>
</head>
<body>
<header>
  <div class="brand">
    <div class="logo">MC</div>
    <div>
      <h1>Matrona Daniela Cris√≥stomo</h1>
      <div style="font-size:0.85rem;color:rgba(255,255,255,0.9)">Profesional en salud femenina ¬∑ Atenci√≥n en Linares y Talca</div>
    </div>
  </div>
  <nav>
    <a href="#inicio">Inicio</a>
    <a href="#servicios">Servicios</a>
    <a href="#agenda">Agenda</a>
    <a href="#contacto">Contacto</a>
  </nav>
</header>

<main class="container">
<section id="inicio" class="hero" style="position:relative;overflow:hidden;">
  <!-- Fondo decorativo -->
  <div style="position:absolute;inset:0;background:radial-gradient(circle at top right, rgba(232,74,148,0.2), transparent 70%);z-index:0;"></div>

  <div style="position:relative;z-index:1;display:flex;flex-direction:column;gap:20px;align-items:flex-start;">
    <h1 style="font-family:'Georgia', serif; font-size:3rem; color:var(--accent); margin:0; line-height:1.2; text-shadow:0 3px 10px rgba(0,0,0,0.12);">
      Matrona Cris√≥stomo
    </h1>
    <p style="font-size:1.2rem; max-width:650px; color:#444; line-height:1.5;">
      Soy Matrona Daniela Cris√≥stomo, especialista en salud femenina y procedimientos est√©ticos √≠ntimos. Brindo atenci√≥n cercana, profesional y personalizada en Linares y Talca.
    </p>
    <div class="cta">
      <a class="btn" href="#agenda">Reservar hora</a>
      <a class="btn secondary" href="#servicios" style="margin-left:10px">Ver servicios y precios</a>
    </div>
    <div style="display:flex;gap:10px;flex-wrap:wrap; margin-top:10px;">
      <span class="chip" style="background:#ffe9f6;color:#b4006a;">PRP</span>
      <span class="chip" style="background:#ffe9f6;color:#b4006a;">HIFU √≠ntimo</span>
      <span class="chip" style="background:#ffe9f6;color:#b4006a;">Plasmapen</span>
      <span class="chip" style="background:#ffe9f6;color:#b4006a;">Ex√°menes</span>
    </div>
  </div>

  <!-- Foto destacada -->
  <aside class="hero-right card" style="width:100%; max-width:500px; margin-top:20px; align-self:center; box-shadow:0 18px 45px rgba(232,77,166,0.08); border-radius:16px; overflow:hidden;">
    <img src="https://images.pexels.com/photos/3757942/pexels-photo-3757942.jpeg?auto=compress&q=60&w=1200&h=800&fit=crop" 
         alt="Matrona Daniela Cris√≥stomo" style="width:100%; height:360px; object-fit:cover; border-radius:16px 16px 0 0;">
    <div style="padding:16px; background:rgba(255,255,255,0.9); backdrop-filter:blur(4px);">
      <strong style="color:var(--accent); font-size:1.1rem;">Atenciones destacadas</strong>
      <div style="display:flex;gap:8px;margin-top:10px;flex-wrap:wrap;">
        <span class="chip">PRP</span>
        <span class="chip">HIFU √≠ntimo</span>
        <span class="chip">Plasmapen</span>
        <span class="chip">Ex√°menes</span>
      </div>
    </div>
  </aside>
</section>

  <!-- Agenda -->
  <section id="agenda" class="grid">
    <div>
      <div class="card">
        <h3 style="color:var(--accent)">Reservar hora</h3>
        <p class="small">Selecciona ciudad, fecha y hora. Recibir√°s confirmaci√≥n por WhatsApp; la cl√≠nica recibir√° un correo con los datos.</p>

        <div class="calendar">
          <label>Ciudad de atenci√≥n</label>
          <select id="city">
            <option value="Linares">Linares ‚Äî Cl√≠nica Ray√©n, Manuel Rodr√≠guez 839</option>
            <option value="Talca">Talca ‚Äî 2 Sur 2 Oriente, Edificio Espacio Talca, Piso 13, Oficina 1315</option>
          </select>

          <label style="margin-top:8px">Fecha</label>
          <input id="date" type="date" />

          <label style="margin-top:8px">Horas disponibles</label>
          <div class="hours" id="hours"></div>

          <label style="margin-top:10px">Servicio</label>
          <select id="serviceSelect"></select>

          <label style="margin-top:8px">Nombre completo</label>
          <input id="clientName" type="text" placeholder="Nombre y apellido" />

          <label style="margin-top:8px">Correo electr√≥nico</label>
          <input id="clientEmail" type="email" placeholder="ejemplo@correo.cl" />

          <label style="margin-top:8px">WhatsApp (ej: +569XXXXXXXX)</label>
          <input id="clientPhone" type="tel" placeholder="+569" />

          <div style="margin-top:12px;display:flex;gap:10px;align-items:center">
            <button id="confirmBtn" class="btn">Confirmar reserva</button>
            <button id="resetForm" class="btn secondary" style="border:1px solid rgba(255,77,166,0.08)">Limpiar</button>
          </div>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <h4 style="color:var(--accent)">Reservas pr√≥ximas</h4>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button class="chip" id="showLinares">Linares</button>
          <button class="chip" id="showTalca">Talca</button>
        </div>
        <div id="reservedList" class="reserved-list" style="margin-top:10px"></div>
      </div>
    </div>

    <aside>
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <h3 style="color:var(--accent)">Panel administraci√≥n</h3>
          <div class="small">Modo local (localStorage)</div>
        </div>
        <p class="small">Configura disponibilidad por ciudad y fecha. Puedes liberar reservas desde aqu√≠.</p>

        <label style="margin-top:8px">Ciudad</label>
        <select id="adminCity"><option>Linares</option><option>Talca</option></select>

        <label style="margin-top:8px">Fecha</label>
        <input id="adminDate" type="date" />

        <div class="admin-panel" style="margin-top:10px">
          <label style="font-weight:700">Horas base</label>
          <div id="adminTimes" style="margin-top:8px;display:flex;flex-wrap:wrap;gap:8px"></div>

          <div style="margin-top:10px;display:flex;gap:8px">
            <button class="btn" id="saveAvailability">Guardar disponibilidad</button>
            <button class="btn secondary" id="clearAvailability">Limpiar fecha</button>
          </div>

          <div style="margin-top:12px">
            <label style="font-weight:700">Reservas en la fecha</label>
            <div id="adminReservations" style="margin-top:8px"></div>
          </div>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <h4 style="color:var(--accent)">Ajustes r√°pidos</h4>
        <div id="presetTimesWrap" style="margin-top:8px"></div>
        <p class="small" style="margin-top:10px">Presets para marcar r√°pidamente horarios frecuentes.</p>
      </div>
    </aside>
  </section>

  <!-- Contact -->
  <section id="contacto" class="section card">
    <h3 style="color:var(--accent)">Contacto & Redes</h3>
    <p class="small">Contacto directo para consultas y urgencias. Tambi√©n puedes escribir al correo para coordinaci√≥n o facturaci√≥n.</p>
    <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:12px">
      <a class="btn" href="https://wa.me/56995880252?text=Hola%20Matrona%20Cris%C3%B3stomo%2C%20tengo%20una%20consulta." target="_blank">WhatsApp +56 9 9588 0252</a>
      <a class="btn secondary" href="mailto:dcrisostomocastro@gmail.com">dcrisostomocastro@gmail.com</a>
      <a class="btn secondary" href="https://instagram.com/matrona_crisostomo" target="_blank">Instagram</a>
      <a class="btn secondary" href="https://facebook.com/Matrona-Daniela-Crisostomo" target="_blank">Facebook</a>
    </div>
    <p class="small" style="margin-top:10px">Direcciones: <strong>Linares:</strong> Cl√≠nica Ray√©n, Manuel Rodr√≠guez 839 ¬∑ <strong>Talca:</strong> 2 Sur 2 Oriente, Edificio Espacio Talca, Piso 13, Oficina 1315</p>
  </section>
</main>

<a class="whatsapp-fab" id="waFab" href="https://wa.me/56995880252?text=Hola%20Matrona%20Cris%C3%B3stomo%2C%20tengo%20una%20consulta." target="_blank" title="WhatsApp">üí¨</a>

<div id="modalRoot" style="display:none"></div>

<script>
/* Config */
const MAT_EMAIL = "dcrisostomocastro@gmail.com";
const MAT_WA = "+56995880252";
const STORAGE_KEY = "mc_agenda_mc_v3";
const BASE_HOURS = ["09:00","09:30","10:00","10:30","11:00","11:30","12:00","15:00","15:30","16:00","16:30","17:00"];
const ADDRESSES = {
  "Linares":"Cl√≠nica Ray√©n, Manuel Rodr√≠guez 839",
  "Talca":"2 Sur 2 Oriente, Edificio Espacio Talca, Piso 13, Oficina 1315"
};

/* Services data (with reference photos & prices) */
const SERVICES = [
  {id:"consulta", title:"Consulta de Matrona", desc:"Evaluaci√≥n ginecol√≥gica integral y seguimiento personalizado.", price:"$35.000", img:"https://images.pexels.com/photos/8460153/pexels-photo-8460153.jpeg"},
  {id:"examenes", title:"Toma de Ex√°menes", desc:"PAP/Citolog√≠a, Tipificaci√≥n VPH, Panel ITS, estreptococo grupo B, cultivos.", price:"desde $20.000", img:"https://images.pexels.com/photos/5452201/pexels-photo-5452201.jpeg"},
  {id:"testrapid", title:"Test R√°pido ITS", desc:"Resultados r√°pidos y confidenciales.", price:"$25.000", img:"https://images.pexels.com/photos/3825529/pexels-photo-3825529.jpeg"},
  {id:"implantes", title:"Implantes Anticonceptivos", desc:"Inserci√≥n y extracci√≥n con t√©cnica segura.", price:"$40.000", img:"https://images.pexels.com/photos/5452218/pexels-photo-5452218.jpeg"},
  {id:"diu", title:"DIU (inserci√≥n/extracci√≥n)", desc:"Procedimiento con consejer√≠a previa.", price:"$40.000", img:"https://images.pexels.com/photos/7490931/pexels-photo-7490931.jpeg"},
  {id:"consejeria", title:"Consejer√≠a Anticonceptiva", desc:"Elecci√≥n informada del m√©todo m√°s apropiado.", price:"$25.000", img:"https://images.pexels.com/photos/5300240/pexels-photo-5300240.jpeg"},
  {id:"control_emb", title:"Control de Embarazo", desc:"Monitoreo cl√≠nico y apoyo durante la gestaci√≥n.", price:"$35.000", img:"https://images.pexels.com/photos/5300240/pexels-photo-5300240.jpeg"},
  {id:"prp", title:"PRP (Facial / √çntimo)", desc:"Regeneraci√≥n con plaquetas propias.", price:"Facial $80.000 ¬∑ √çntimo $120.000", img:"https://images.pexels.com/photos/3861456/pexels-photo-3861456.jpeg"},
  {id:"hifu", title:"HIFU √çntimo", desc:"Rejuvenecimiento √≠ntimo no invasivo.", price:"$150.000", img:"https://images.pexels.com/photos/6628451/pexels-photo-6628451.jpeg"},
  {id:"plasmapen", title:"Plasmapen", desc:"Extracci√≥n de condilomas, moluscos y acrocordones.", price:"desde $50.000", img:"https://images.pexels.com/photos/6231608/pexels-photo-6231608.jpeg"}
];

/* Storage helpers */
function loadStore(){ try{const r=localStorage.getItem(STORAGE_KEY); return r?JSON.parse(r):{availability:{},reservations:[]}; }catch(e){console.error(e); return {availability:{},reservations:[]};}}
function saveStore(s){ localStorage.setItem(STORAGE_KEY, JSON.stringify(s)); }
let store = loadStore();

/* DOM refs */
const servicesGrid = document.getElementById("servicesGrid");
const serviceSelect = document.getElementById("serviceSelect");
const cityEl = document.getElementById("city");
const dateEl = document.getElementById("date");
const hoursEl = document.getElementById("hours");
const nameEl = document.getElementById("clientName");
const emailEl = document.getElementById("clientEmail");
const phoneEl = document.getElementById("clientPhone");
const confirmBtn = document.getElementById("confirmBtn");
const resetFormBtn = document.getElementById("resetForm");
const reservedListEl = document.getElementById("reservedList");

const adminCityEl = document.getElementById("adminCity");
const adminDateEl = document.getElementById("adminDate");
const adminTimesEl = document.getElementById("adminTimes");
const saveAvailabilityBtn = document.getElementById("saveAvailability");
const clearAvailabilityBtn = document.getElementById("clearAvailability");
const adminReservationsEl = document.getElementById("adminReservations");
const presetTimesWrap = document.getElementById("presetTimesWrap");
const showLinaresBtn = document.getElementById("showLinares");
const showTalcaBtn = document.getElementById("showTalca");

dateEl.min = (new Date()).toISOString().split("T")[0];
adminDateEl.min = dateEl.min;
dateEl.value = dateEl.min;
adminDateEl.value = dateEl.min;

let selectedHour = null;

/* Render services (cards & select) */
function renderServices(){
  servicesGrid.innerHTML = "";
  serviceSelect.innerHTML = "";
  SERVICES.forEach(s=>{
    // card
    const card = document.createElement("div"); card.className="service";
    card.innerHTML = `<img src="${s.img}?auto=compress&q=60&w=1200&h=800&fit=crop" alt="${s.title}">
      <h4>${s.title}</h4><p>${s.desc}</p><div class="price">${s.price}</div>`;
    servicesGrid.appendChild(card);
    // select option
    const opt = document.createElement("option"); opt.value = s.title + " ¬∑ " + s.price; opt.textContent = s.title + " ‚Äî " + s.price;
    serviceSelect.appendChild(opt);
  });
}

/* Availability & reservations helpers */
function getAvailability(city,date){ return (store.availability && store.availability[city] && store.availability[city][date]) || []; }
function getReservations(city,date){ return (store.reservations || []).filter(r => r.city===city && r.date===date); }

/* Render hours for chosen city+date */
function renderHours(){
  const city = cityEl.value;
  const date = dateEl.value;
  hoursEl.innerHTML = ""; selectedHour = null;
  if(!date){ hoursEl.innerHTML = "<div class='small'>Selecciona una fecha</div>"; return; }
  const avail = getAvailability(city,date);
  const reserved = getReservations(city,date).map(r=>r.time);
  if(!avail || avail.length===0){ hoursEl.innerHTML = "<div class='small'>No hay disponibilidad configurada para esta fecha. Revisa el panel de administraci√≥n o contacta por WhatsApp.</div>"; return; }
  avail.forEach(h=>{
    const b = document.createElement("div"); b.className="hour"; b.textContent=h;
    if(reserved.includes(h)){ b.classList.add("disabled"); b.title="Reservado"; }
    else b.onclick = ()=> selectHour(b,h);
    hoursEl.appendChild(b);
  });
}
function selectHour(el,h){
  document.querySelectorAll(".hour").forEach(x=>x.classList.remove("selected"));
  el.classList.add("selected");
  selectedHour = h;
}

/* Render reservation list */
function renderReservedList(city){
  reservedListEl.innerHTML = "";
  const upcoming = (store.reservations || []).filter(r=> r.city===city).sort((a,b)=> (a.date+a.time) > (b.date+b.time) ? 1:-1);
  if(!upcoming.length){ reservedListEl.innerHTML = "<div class='small'>No hay reservas</div>"; return; }
  upcoming.slice(0,8).forEach(r=>{
    const div = document.createElement("div"); div.className="reserved-item";
    div.innerHTML = `<div><strong style="color:var(--accent)">${r.date} ${r.time}</strong><div class="small">${r.name} ¬∑ ${r.service}</div></div>
      <div style="display:flex;flex-direction:column;gap:8px;align-items:flex-end">
        <a class="small" href="${waHrefToNumber(r.phone, r.name, r.date, r.time, r.service, r.city)}" target="_blank" style="text-decoration:none;color:var(--muted)">WhatsApp paciente</a>
        <button class="chip" style="background:#fff;border:1px solid rgba(0,0,0,0.06)" onclick="cancelReservation('${r.id}')">Liberar</button>
      </div>`;
    reservedListEl.appendChild(div);
  });
}

/* Admin UI */
function renderAdminTimes(){
  adminTimesEl.innerHTML="";
  BASE_HOURS.forEach(h=>{
    const id = "a_"+h.replace(":","");
    const wrapper = document.createElement("label");
    wrapper.style.display="inline-flex"; wrapper.style.alignItems="center"; wrapper.style.gap="6px";
    wrapper.style.marginRight="6px"; wrapper.style.marginBottom="6px";
    const chk = document.createElement("input"); chk.type="checkbox"; chk.id=id; chk.dataset.hour=h;
    wrapper.appendChild(chk);
    const span = document.createElement("span"); span.textContent=h; span.style.fontWeight="700"; span.style.padding="6px 8px";
    span.style.borderRadius="8px"; span.style.background="#fff"; span.style.border="1px solid #ffd6ec";
    wrapper.appendChild(span);
    adminTimesEl.appendChild(wrapper);
  });
}
function renderPreset(){
  presetTimesWrap.innerHTML="";
  const p = document.createElement("div"); p.style.display="flex"; p.style.gap="8px"; p.style.flexWrap="wrap";
  ["Bloque ma√±anas (09:00-12:00)","Tardes (15:00-17:00)","Solo ma√±ana","Personalizado"].forEach(text=>{
    const btn = document.createElement("button"); btn.className="chip"; btn.textContent=text;
    btn.onclick = ()=> applyPreset(text); p.appendChild(btn);
  });
  presetTimesWrap.appendChild(p);
}
function applyPreset(name){
  const map = {
    "Bloque ma√±anas (09:00-12:00)": BASE_HOURS.filter(h=>h>="09:00"&&h<="12:00"),
    "Tardes (15:00-17:00)": BASE_HOURS.filter(h=>h>="15:00"&&h<="17:00"),
    "Solo ma√±ana": BASE_HOURS.filter(h=>h>="09:00"&&h<="12:00").slice(0,3)
  };
  const selected = map[name]||[];
  BASE_HOURS.forEach(h=> document.querySelector(`#a_${h.replace(":","")}`).checked = selected.includes(h));
}
function fillAdminCheckboxesFromStore(){
  const city = adminCityEl.value; const date = adminDateEl.value;
  const avail = getAvailability(city,date);
  BASE_HOURS.forEach(h=> document.querySelector(`#a_${h.replace(":","")}`).checked = avail.includes(h));
}
function renderAdminReservations(){
  adminReservationsEl.innerHTML="";
  const city = adminCityEl.value; const date = adminDateEl.value;
  const list = getReservations(city,date);
  if(!list.length){ adminReservationsEl.innerHTML="<div class='small'>No hay reservas para la fecha</div>"; return; }
  list.forEach(r=>{
    const item = document.createElement("div"); item.className="reserved-item";
    item.innerHTML = `<div><strong>${r.time}</strong><div class="small">${r.name} ¬∑ ${r.service}</div></div>
      <div style="display:flex;flex-direction:column;gap:6px">
        <a class="small" href="${waHrefToNumber(r.phone,r.name,r.date,r.time,r.service,r.city)}" target="_blank">WhatsApp</a>
        <button class="chip" onclick="cancelReservation('${r.id}')">Liberar</button>
      </div>`;
    adminReservationsEl.appendChild(item);
  });
}

/* Save / Clear availability */
saveAvailabilityBtn.addEventListener("click", ()=>{
  const city = adminCityEl.value; const date = adminDateEl.value;
  if(!date){ alert("Selecciona una fecha"); return; }
  const sel = []; BASE_HOURS.forEach(h=>{ if(document.querySelector(`#a_${h.replace(":","")}`).checked) sel.push(h); });
  store.availability = store.availability || {}; store.availability[city] = store.availability[city] || {}; store.availability[city][date] = sel;
  saveStore(store); renderHours(); renderAdminReservations(); showModal("Disponibilidad guardada ‚úîÔ∏è");
});
clearAvailabilityBtn.addEventListener("click", ()=>{
  const city = adminCityEl.value; const date = adminDateEl.value;
  if(!date) return alert("Selecciona una fecha");
  if(!confirm("Eliminar disponibilidad para esta fecha? (No eliminar√° reservas existentes)")) return;
  if(store.availability && store.availability[city]) delete store.availability[city][date];
  saveStore(store); renderAdminTimes(); fillAdminCheckboxesFromStore(); renderHours(); showModal("Disponibilidad eliminada");
});

/* Create / Cancel reservation */
function createReservation({city,date,time,name,email,phone,service}){
  const id = Math.random().toString(36).slice(2,9);
  const r = {id,city,date,time,name,email,phone,service,createdAt:new Date().toISOString()};
  store.reservations = store.reservations || []; store.reservations.push(r); saveStore(store);
  return r;
}
function cancelReservation(id){
  if(!confirm("¬øConfirmas liberar esta reserva?")) return;
  store.reservations = (store.reservations||[]).filter(r=>r.id!==id); saveStore(store);
  renderHours(); renderReservedList(adminCityEl.value); renderAdminReservations();
}

/* WhatsApp & mail helpers */
function waHrefToNumber(number,name,date,time,service,city){
  const num = (number||"").replace(/\D/g,"");
  if(!num) return `https://wa.me/${MAT_WA.replace(/\D/g,'')}?text=${encodeURIComponent(`Hola, soy ${name} y quer√≠a consultar mi reserva.`)}`;
  const text = `Hola ${name}, tu hora con Matrona Cris√≥stomo ha sido confirmada.%0A%0AüìÖ Fecha: ${date}%0A‚è∞ Hora: ${time}%0AüíÜ‚Äç‚ôÄÔ∏è Servicio: ${service}%0Aüìç Ubicaci√≥n: ${ADDRESSES[city]}%0A%0ATe esperamos con cari√±o üíó`;
  return `https://wa.me/${num}?text=${text}`;
}
function mailToMatrona(res){
  const subject = `Nueva reserva: ${res.name} - ${res.date} ${res.time}`;
  const body = `Nueva reserva recibida:%0A%0ANombre: ${res.name}%0AWhatsApp: ${res.phone || 'No indicado'}%0AEmail: ${res.email || 'No indicado'}%0ACiudad: ${res.city}%0AUbicaci√≥n: ${ADDRESSES[res.city]}%0AServicio: ${res.service}%0AFecha: ${res.date}%0AHora: ${res.time}%0AID: ${res.id}%0A%0ARegistrado en el sistema local.`;
  return `mailto:${MAT_EMAIL}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
}

/* Confirm reservation flow */
confirmBtn.addEventListener("click", ()=>{
  const city = cityEl.value; const date = dateEl.value; const service = serviceSelect.value;
  const name = nameEl.value.trim(); const email = emailEl.value.trim(); const phone = phoneEl.value.trim();
  const time = selectedHour;
  if(!date) return alert("Selecciona una fecha");
  if(!time) return alert("Selecciona una hora disponible");
  if(!name) return alert("Ingresa tu nombre completo");
  if(!phone) return alert("Ingresa tu WhatsApp (ej: +569XXXXXXXX)");
  const reservations = getReservations(city,date);
  if(reservations.some(r=> r.time===time)) return alert("Lo siento, la hora ya fue reservada. Elige otra.");
  const r = createReservation({city,date,time,name,email,phone,service});
  // open mailto to matrona (so clinic receives an email)
  const mail = mailToMatrona(r);
  window.open(mail,"_blank");
  // open whatsapp to patient
  const wa = waHrefToNumber(phone,name,date,time,service,city);
  window.open(wa,"_blank");
  // update UI
  renderHours(); renderReservedList(city); renderAdminReservations();
  showModal(`<h4>¬°Reserva registrada!</h4><p>Se ha registrado la reserva <strong>${date} ${time}</strong> para <strong>${name}</strong>.</p><p>Se abri√≥ su correo para notificar a la cl√≠nica y WhatsApp para confirmar con el paciente.</p>`);
});

/* Utilities: modal */
function showModal(html){ const root = document.getElementById("modalRoot"); root.innerHTML = `<div class="modal-backdrop" onclick="closeModal(event)"><div class="modal" onclick="event.stopPropagation()">${html}<div style="text-align:right;margin-top:14px"><button class="btn" onclick="closeModal()">Cerrar</button></div></div></div>`; root.style.display="block"; }
function closeModal(){ const r=document.getElementById("modalRoot"); r.style.display="none"; r.innerHTML=""; }
window.closeModal = closeModal;

/* Init: default availability (demo) if empty */
function init(){
  renderServices(); renderAdminTimes(); renderPreset();
  if(!store.availability || Object.keys(store.availability).length===0){
    store.availability = store.availability || {};
    ["Linares","Talca"].forEach(city=>{
      store.availability[city] = store.availability[city] || {};
      for(let i=0;i<10;i++){
        const d = new Date(); d.setDate(d.getDate()+i); const iso = d.toISOString().split("T")[0];
        const weekend = [0,6].includes(d.getDay());
        store.availability[city][iso] = weekend ? BASE_HOURS.filter(h=>h<="11:30") : BASE_HOURS.slice();
      }
    });
    saveStore(store);
  }
  // populate select services
  renderHours(); renderReservedList("Linares"); fillAdminCheckboxesFromStore(); renderAdminReservations();

  // event bindings
  cityEl.addEventListener("change", ()=> renderHours());
  dateEl.addEventListener("change", ()=> { selectedHour=null; renderHours(); });
  adminCityEl.addEventListener("change", ()=> fillAdminCheckboxesFromStore());
  adminDateEl.addEventListener("change", ()=> fillAdminCheckboxesFromStore());
  showLinaresBtn.addEventListener("click", ()=> renderReservedList("Linares"));
  showTalcaBtn.addEventListener("click", ()=> renderReservedList("Talca"));
  document.getElementById("resetForm").addEventListener("click", ()=> { nameEl.value=""; emailEl.value=""; phoneEl.value=""; selectedHour=null; document.querySelectorAll(".hour").forEach(x=>x.classList.remove("selected")); });
}
init();

/* Expose cancelReservation globally */
window.cancelReservation = cancelReservation;
</script>
</body>
</html>
